# ğŸš€ API WhatsApp TypeScript

API REST para enviar mensajes de WhatsApp usando **Baileys** (WhatsApp Web Multi-Device). Ideal para integrar WhatsApp en tus aplicaciones de forma programÃ¡tica.

## ğŸ“‹ CaracterÃ­sticas

- âœ… **TypeScript**: CÃ³digo completamente tipado
- âœ… **Arquitectura Limpia**: SeparaciÃ³n de capas (Domain, Application, Infrastructure)
- âœ… **MÃºltiples Proveedores**: Soporte para Baileys, Venom, Twilio, y Meta
- âœ… **InyecciÃ³n de Dependencias**: FÃ¡cil cambio entre proveedores
- âœ… **Docker Ready**: Listo para contenedores
- âœ… **Railway Ready**: Configurado para despliegue en Railway

## ğŸ› ï¸ InstalaciÃ³n Local

### Requisitos Previos
- Node.js 18 o superior
- npm o pnpm

### Pasos de InstalaciÃ³n

1. **Clona el repositorio**
```bash
git clone <tu-repositorio>
cd api-whatsapp-ts
```

2. **Instala las dependencias**
```bash
npm install
# o
pnpm install
```

3. **Configura las variables de entorno**
```bash
# Copia el archivo de ejemplo
cp env.example .env

# Edita el archivo .env con tus valores
```

4. **Compila el proyecto**
```bash
npm run build
```

5. **Inicia el servidor**
```bash
# Modo desarrollo
npm run dev

# Modo producciÃ³n
npm start
```

El servidor estarÃ¡ corriendo en `http://localhost:3001`

## ğŸ“± Conectar WhatsApp

Al iniciar la aplicaciÃ³n por primera vez, se generarÃ¡ un **cÃ³digo QR** en la terminal. 

1. Abre WhatsApp en tu telÃ©fono
2. Ve a **ConfiguraciÃ³n** > **Dispositivos vinculados**
3. Toca en **Vincular un dispositivo**
4. Escanea el cÃ³digo QR que aparece en la terminal

Â¡Tu sesiÃ³n quedarÃ¡ guardada en la carpeta `tokens/`!

## ğŸ”Œ Uso de la API

### Enviar Mensaje

**Endpoint:** `POST /lead`

**Body (JSON):**
```json
{
  "phone": "521234567890",
  "message": "Â¡Hola! Este es un mensaje de prueba"
}
```

**Formato del telÃ©fono:**
- Incluye el cÃ³digo de paÃ­s sin el sÃ­mbolo `+`
- Ejemplo para MÃ©xico: `521234567890`
- Ejemplo para EspaÃ±a: `34612345678`

**Respuesta:**
```json
{
  "responseDbSave": {
    "uuid": "123e4567-e89b-12d3-a456-426614174000",
    "message": "Â¡Hola! Este es un mensaje de prueba",
    "phone": "521234567890"
  },
  "responseExSave": {
    "status": 200,
    "message": "Mensaje enviado exitosamente"
  }
}
```

### Ejemplo con cURL

```bash
curl -X POST http://localhost:3001/lead \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "521234567890",
    "message": "Hola desde la API"
  }'
```

### Ejemplo con JavaScript/Fetch

```javascript
fetch('http://localhost:3001/lead', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    phone: '521234567890',
    message: 'Hola desde JavaScript'
  })
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error:', error));
```

## ğŸš‚ Desplegar en Railway

### OpciÃ³n 1: Desde GitHub (Recomendado)

1. **Sube tu cÃ³digo a GitHub**
```bash
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin <tu-repositorio-github>
git push -u origin main
```

2. **Conecta con Railway**
   - Ve a [railway.app](https://railway.app)
   - Inicia sesiÃ³n con GitHub
   - Click en **"New Project"**
   - Selecciona **"Deploy from GitHub repo"**
   - Selecciona tu repositorio
   - Railway detectarÃ¡ automÃ¡ticamente la configuraciÃ³n

3. **Configura las variables de entorno**
   - En el dashboard de Railway, ve a **Variables**
   - Agrega: `PORT=3001` (Railway lo asignarÃ¡ automÃ¡ticamente)

4. **ObtÃ©n tu URL pÃºblica**
   - Railway te asignarÃ¡ un dominio automÃ¡ticamente
   - TambiÃ©n puedes configurar un dominio personalizado

### OpciÃ³n 2: Usando Railway CLI

```bash
# Instala Railway CLI
npm i -g @railway/cli

# Inicia sesiÃ³n
railway login

# Inicia el proyecto
railway init

# Despliega
railway up
```

## ğŸ³ Desplegar con Docker

### Construir la imagen

```bash
docker build -t api-whatsapp-ts .
```

### Ejecutar el contenedor

```bash
docker run -d \
  --name whatsapp-api \
  -p 3001:3001 \
  -e PORT=3001 \
  -v $(pwd)/tokens:/app/tokens \
  api-whatsapp-ts
```

**Importante:** El flag `--privileged` puede ser necesario para Puppeteer/Chromium en algunos entornos:

```bash
docker run -d --privileged \
  --name whatsapp-api \
  -p 3001:3001 \
  -e PORT=3001 \
  -v $(pwd)/tokens:/app/tokens \
  api-whatsapp-ts
```

### Ver el QR Code

```bash
docker logs whatsapp-api
```

## ğŸ”„ Cambiar de Proveedor de WhatsApp

El proyecto soporta mÃºltiples proveedores. Para cambiar, edita `src/infrastructure/ioc.ts`:

### Usar Baileys (Por defecto - Gratis)
```typescript
container.register("ws.transporter", BaileysTransporter);
```

### Usar Venom (Gratis)
```typescript
container.register("ws.transporter", VenomTransporter);
```

### Usar Twilio (Pago)
```typescript
container.register("ws.transporter", TwilioService);
```

### Usar Meta/Facebook (Pago)
```typescript
container.register("ws.transporter", MetaRepository);
```

## ğŸ“ Estructura del Proyecto

```
api-whatsapp-ts/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/              # Entidades y contratos
â”‚   â”‚   â”œâ”€â”€ lead.ts
â”‚   â”‚   â”œâ”€â”€ lead.repository.ts
â”‚   â”‚   â””â”€â”€ lead-external.repository.ts
â”‚   â”œâ”€â”€ application/         # Casos de uso
â”‚   â”‚   â””â”€â”€ lead.create.ts
â”‚   â”œâ”€â”€ infrastructure/      # Implementaciones
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â””â”€â”€ lead.ctrl.ts
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”œâ”€â”€ baileys.repository.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ venom.repository.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ twilio.repository.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ meta.repository.ts
â”‚   â”‚   â”‚   â””â”€â”€ mock.repository.ts
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ lead.route.ts
â”‚   â”‚   â””â”€â”€ ioc.ts          # InyecciÃ³n de dependencias
â”‚   â””â”€â”€ app.ts              # Punto de entrada
â”œâ”€â”€ tokens/                  # Sesiones de WhatsApp (git ignored)
â”œâ”€â”€ tmp/                     # Archivos temporales
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ railway.json            # ConfiguraciÃ³n de Railway
â”œâ”€â”€ nixpacks.toml          # ConfiguraciÃ³n de build
â””â”€â”€ package.json
```

## âš™ï¸ Variables de Entorno

| Variable | DescripciÃ³n | Por Defecto |
|----------|-------------|-------------|
| `PORT` | Puerto del servidor | `3001` |
| `SESSION_NAME` | Nombre de la sesiÃ³n de WhatsApp | `default` |
| `PUBLIC_URL` | URL pÃºblica de la app (para Railway) | - |

## ğŸ”’ Seguridad

**âš ï¸ Importante:**
- Nunca subas la carpeta `tokens/` a Git (contiene tu sesiÃ³n de WhatsApp)
- Nunca compartas tu archivo `.env`
- En producciÃ³n, usa variables de entorno seguras
- Considera implementar autenticaciÃ³n en los endpoints

## ğŸ› Problemas Comunes

### El QR no aparece
- AsegÃºrate de que el puerto no estÃ© en uso
- Verifica que las dependencias estÃ©n instaladas correctamente
- En Docker, usa el flag `--privileged`

### "Connection closed"
- Puede que la sesiÃ³n haya expirado
- Elimina la carpeta `tokens/` y vuelve a escanear el QR

### Error en Railway
- AsegÃºrate de que el `PORT` sea asignado por Railway (no hardcodeado)
- Verifica que Chromium estÃ© disponible (estÃ¡ en el `nixpacks.toml`)

## ğŸ“ PrÃ³ximas Mejoras

- [ ] Implementar base de datos real (PostgreSQL/MongoDB)
- [ ] Agregar autenticaciÃ³n JWT
- [ ] Implementar webhooks para mensajes recibidos
- [ ] Panel de administraciÃ³n web
- [ ] Soporte para enviar imÃ¡genes/archivos
- [ ] Rate limiting
- [ ] Logs estructurados

## ğŸ¤ Contribuciones

Las contribuciones son bienvenidas. Por favor:
1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## ğŸ“„ Licencia

Este proyecto es un fork de [api-whatsapp-ts](https://github.com/leifermendez/api-whatsapp-ts) de @leifermendez.

## ğŸ™ CrÃ©ditos

- Proyecto original: [@leifermendez](https://github.com/leifermendez)
- Baileys: [@WhiskeySockets/Baileys](https://github.com/WhiskeySockets/Baileys)

---

**Hecho con â¤ï¸ para facilitar la integraciÃ³n de WhatsApp en tus proyectos**
